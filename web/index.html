<!DOCTYPE html>
<html lang="en">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <meta charset="UTF-8">
    <title>Blackmagic, go sleep!!!</title>
    <script src="eel.js"></script>
    <link rel="stylesheet" href="style.css">
    <meta name="google" content="notranslate" />
    <script type="text/javascript" src="lib/jquery-3.5.1.min.js"></script>
    <script type="text/javascript" src="config.js"></script>
</head>
<body style="height: 100vh; width: 100vw; overflow: hidden; background: #F6F4FE;">
<!--    <div id="ConnetionPage" style="background: #F6F4FE; visibility: visible; position: fixed; width: 100vw; height: 100vh; z-index: 999">-->
<!--        <div class="row pt-3">-->
<!--            <div class="mt-5 input-group col-md-6">-->
<!--                <div class="col-3 m-auto mt-5 pb-4">-->
<!--                    <input type="text" class="form-control mt-5" placeholder="IP" aria-label="IP" name="ip" id="ip">-->
<!--                    <button id="connect" class="mt-2 w-100 btn btn-primary">Connect</button>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
    <div>
        <div class="header bg-white shadow-sm">
            <div class="container pt-2 pb-2">
                <ul class="nav nav-pills">
                  <li class="nav-item">
                    <a class="nav-link active" aria-current="page">Switcher</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link">Audio</a>
                  </li>
                  <!-- <li class="nav-item">
                    <a class="nav-link" href="#">Link</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link disabled">Disabled</a>
                  </li> -->
                </ul>
            </div>    
        </div>
        <div class="container">
            <div class="row mt-4">
                <div class="col-8">
                    <div class="col pb-4">
                        <h5 class="pb-2">Program</h5>
                        <div class="row">
                            <button id="cam1" class="shadow-sm btn bg-warning" style="width: 10vw; height: 10vw; font-size: 5vw; line-height: 6vw; color: rgba(0,0,0,0.5);text-align: center; align-content: center; justify-content: center;">
                                1
                            </button>
                            <button id="cam2" class="ms-4 shadow-sm btn bg-white" style="width: 10vw; height: 10vw; font-size: 5vw; line-height: 6vw; color: rgba(0,0,0,0.5);text-align: center; align-content: center; justify-content: center;">
                                2
                            </button>
                            <button id="cam3" class="ms-4 shadow-sm btn bg-white" style="width: 10vw; height: 10vw; font-size: 5vw; line-height: 6vw; color: rgba(0,0,0,0.5);text-align: center; align-content: center; justify-content: center;">
                                3
                            </button>
                            <button id="camPC" class="ms-4 shadow-sm btn bg-white" style="width: 10vw; height: 10vw; font-size: 5vw; line-height: 6vw; color: rgba(0,0,0,0.5);text-align: center; align-content: center; justify-content: center;">
                                PC
                            </button>
                        </div>
                    </div>
                    <div class="col pb-4">
                        <h5 class="pb-2">Preview</h5>
                        <div class="row">
                            <button id="camPreview1" class="shadow-sm btn bg-warning" style="width: 10vw; height: 10vw; font-size: 5vw; line-height: 6vw; color: rgba(0,0,0,0.5);text-align: center; align-content: center; justify-content: center;">
                                1
                            </button>
                            <button id="camPreview2" class="ms-4 shadow-sm btn bg-white" style="width: 10vw; height: 10vw; font-size: 5vw; line-height: 6vw; color: rgba(0,0,0,0.5);text-align: center; align-content: center; justify-content: center;">
                                2
                            </button>
                            <button id="camPreview3" class="ms-4 shadow-sm btn bg-white" style="width: 10vw; height: 10vw; font-size: 5vw; line-height: 6vw; color: rgba(0,0,0,0.5);text-align: center; align-content: center; justify-content: center;">
                                3
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="rounded" style="width: 7vw; height: 50vh;">
                        <div class="middle">
                            <div class="slider-container shadow-sm">
                                <span class="bar"><span class="fill"></span></span>
                                <input id="slider" class="slider" type="range" min="0" max="100" value="0" >
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- <div class="container">
            <div class="row mt-4">
                <div class="col-8">
                    <div class="col pb-4">
                        <h5 class="pb-2">Program</h5>
                        <div class="row">
                            <button id="cam1" class="shadow-sm btn bg-warning" style="width: 10vw; height: 10vw; font-size: 5vw; line-height: 6vw; color: rgba(0,0,0,0.5);text-align: center; align-content: center; justify-content: center;">
                                1
                            </button>
                            <button id="cam2" class="ms-4 shadow-sm btn bg-white" style="width: 10vw; height: 10vw; font-size: 5vw; line-height: 6vw; color: rgba(0,0,0,0.5);text-align: center; align-content: center; justify-content: center;">
                                2
                            </button>
                            <button id="cam3" class="ms-4 shadow-sm btn bg-white" style="width: 10vw; height: 10vw; font-size: 5vw; line-height: 6vw; color: rgba(0,0,0,0.5);text-align: center; align-content: center; justify-content: center;">
                                3
                            </button>
                            <button id="camPC" class="ms-4 shadow-sm btn bg-white" style="width: 10vw; height: 10vw; font-size: 5vw; line-height: 6vw; color: rgba(0,0,0,0.5);text-align: center; align-content: center; justify-content: center;">
                                PC
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div> -->
    </div>
    <script>

        var $slider = $("#slider");
        var $fill = $(".bar .fill");

        function setBar() {
            $fill.css("height", $slider.val() + "%");
            // Send MIX rate
        }

        $slider.on("input", setBar);

        setBar();

        var cCamName = 'cam1';
        var cPreviewCamName = 'camPreview1';
        var PC_Sate = false;

<!--        async function connect() {-->
<!--            await eel.connect(document.getElementById('ip').value) (function(valid){                   -->
<!--                if (valid) {-->
<!--                    document.getElementById('ConnetionPage').remove();-->
<!--                }-->
<!--            });-->
<!--        }-->

<!--        document.getElementById('connect').onclick = function() { connect(); }-->

        function swapCam(inCam) {
            document.getElementById(cCamName).classList.remove("bg-warning");
            document.getElementById(cCamName).classList.add("bg-white");
            cCamName = inCam;
            document.getElementById(inCam).classList.remove("bg-white");
            document.getElementById(inCam).classList.add("bg-warning");
            eel.setProgram(document.getElementById(inCam).innerHTML);
        }

        function swapPreviewCam(inCam) {
            document.getElementById(cPreviewCamName).classList.remove("bg-warning");
            document.getElementById(cPreviewCamName).classList.add("bg-white");
            cPreviewCamName = inCam;
            document.getElementById(inCam).classList.remove("bg-white");
            document.getElementById(inCam).classList.add("bg-warning");
            eel.setPreview(document.getElementById(inCam).innerHTML);
        }

        document.getElementById('cam2').onclick = function() { swapCam("cam2"); }
        document.getElementById('cam1').onclick = function() { swapCam("cam1"); }
        document.getElementById('cam3').onclick = function() { swapCam("cam3"); }

        document.getElementById('camPreview2').onclick = function() { swapPreviewCam("camPreview2"); }
        document.getElementById('camPreview1').onclick = function() { swapPreviewCam("camPreview1"); }
        document.getElementById('camPreview3').onclick = function() { swapPreviewCam("camPreview3"); }

        document.addEventListener('keydown', function(event) {
            if (event.code == 'Digit1') {
                swapPreviewCam("camPreview1")
            }
            if (event.code == 'Digit2') {
                swapPreviewCam("camPreview2")

            }
            if (event.code == 'Digit3') {
                swapPreviewCam("camPreview3")
            }
            if (event.code == 'Space') {
                var c = cCamName;
                console.log(c);
                swapCam("cam"+cPreviewCamName[cPreviewCamName.length - 1]);
                swapPreviewCam('camPreview' + c[c.length - 1]);
            }
        });

        var last_uid = "";

        function activatePC() {
            document.getElementById("camPC").classList.remove("bg-white");
            document.getElementById("camPC").classList.add("bg-warning");
            PC_Sate = true;
        }

        function deactivatePC() {
            document.getElementById("camPC").classList.remove("bg-warning");
            document.getElementById("camPC").classList.add("bg-white");
            PC_State = false;
        }

        function switchPC() {
            if (!PC_Sate) 
                activatePC();
            else 
                deactivatePC();
        }

        document.getElementById('camPC').onclick = function() { switchPC(); }

        function processProPresenterMessage(message) {
            if (message['acn'] == "fv") {
                if (last_uid!=message['ary'][0]['uid']){
                    last_uid = message['ary'][0]['uid'];
                    if (message['ary'][0]['txt'] != undefined && (message['ary'][2]['txt'] == "speaker" || message['ary'][0]['txt'] > 250) && message['ary'][0]['acn'] === 'cs' ) {
                        console.log(message);
                        console.log("Send to ATEM");
                        activatePC();
                    }
                }
            }
        }

        function connectToProPresenter() {
            var proPresenterStageDisplayURL = 'ws://' + config['propresenter_ip'] + ':' + config['propresenter_port'] + '/stagedisplay';
            
            var ws = new WebSocket(proPresenterStageDisplayURL);

            ws.onopen = function() {
                console.log('ProPresenter connection opened');
                ws.send(JSON.stringify({
                                        "pwd": config['propresenter_password'],
                                        "ptl": 610,
                                        "acn": "ath"
                                       }));
            };

            ws.onmessage = function(e) {
                processProPresenterMessage(JSON.parse(e.data));
            };

            ws.onclose = function(e) {
                console.log('ProPresenter socket was closed. Attempting to reconnect in 1 second...', e.reason);
                setTimeout(function() {
                    connectToProPresenter();
                }, 1000);
            };

            ws.onerror = function(err) {
                console.error('ProPresenter socket has error: ', err.message, 'Closing socket');
                ws.close();
            };
        }

        connectToProPresenter();
    </script>
</body>
</html>